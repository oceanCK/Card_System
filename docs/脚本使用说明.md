# 抽卡概率工具 - 脚本使用说明

## 目录结构概览

```
抽卡概率工具/
├── main.py                 # 开发环境启动入口
├── app.py                  # Flask 应用工厂
├── config.py               # 全局配置文件
├── run_production.py       # 生产环境启动脚本
├── data/
│   └── cards.json          # 卡池数据配置
├── models/                 # 数据模型
│   ├── card.py             # 卡牌模型
│   └── pool.py             # 卡池模型
├── routes/                 # 路由层
│   ├── gacha_routes.py     # JSON API 路由
│   └── proto_routes.py     # Protobuf API 路由
├── services/               # 服务层
│   ├── gacha.py            # 核心抽卡逻辑
│   └── gacha_client.py     # 外部服务端客户端
├── proto/                  # Protobuf 相关
│   ├── gacha.proto         # Proto 定义文件
│   ├── compile_proto.py    # Proto 编译脚本
│   ├── converter.py        # Proto 数据转换器
│   └── grpc_server.py      # gRPC 服务端
├── static/js/              # 前端脚本
│   ├── local-gacha.js      # 本地抽卡引擎
│   └── modules/            # 模块化脚本
├── templates/              # HTML 模板
└── examples/               # 示例代码
    └── proto_client_example.py
```

---

## 一、本地模式使用的脚本

本地模式数据存储在浏览器 `localStorage`，不依赖服务端 API。

### 前端脚本（浏览器运行）

| 脚本文件 | 说明 |
|---------|------|
| `static/js/local-gacha.js` | **本地抽卡引擎核心**，包含完整抽卡逻辑、保底机制、统计计算 |
| `static/js/modules/config.js` | 配置模块，定义模式常量、抽卡限制、全局状态 |
| `static/js/modules/api.js` | API 调用模块（本地模式不使用） |
| `static/js/modules/gacha-engine.js` | 统一抽卡引擎，封装本地/服务端模式切换 |
| `static/js/modules/ui.js` | UI 更新模块，处理界面显示 |
| `static/js/modules/event-handlers.js` | 事件处理模块，响应用户操作 |
| `static/js/modules/app.js` | 应用入口，初始化和启动 |

### 数据文件

| 文件 | 说明 |
|-----|------|
| `data/cards.json` | 卡池数据，前端通过 `/data/cards.json` 路由加载 |

### 本地模式限制

- **单次最大抽卡数**: 10,000 次
- **历史记录存储**: 最多 1,000 条

---

## 二、服务端模式使用的脚本

服务端模式数据通过 Flask API 获取，支持更大规模的抽卡压测。

### 后端脚本（服务器运行）

| 脚本文件 | 说明 |
|---------|------|
| `main.py` | **开发环境启动入口**，使用 Flask 内置服务器 |
| `run_production.py` | **生产环境启动脚本**，支持 Waitress/Gunicorn |
| `app.py` | Flask 应用工厂，创建和配置应用实例 |
| `config.py` | **全局配置**，包含抽卡概率、保底机制、服务器配置 |

### 路由层

| 脚本文件 | 说明 |
|---------|------|
| `routes/gacha_routes.py` | **JSON API 路由**，提供 RESTful 接口 |
| `routes/proto_routes.py` | Protobuf API 路由，提供二进制协议接口 |

### 服务层

| 脚本文件 | 说明 |
|---------|------|
| `services/gacha.py` | **核心抽卡服务**，实现抽卡逻辑、保底计算、统计 |
| `services/gacha_client.py` | 外部服务端客户端，用于对接真实游戏服务器 |

### 数据模型

| 脚本文件 | 说明 |
|---------|------|
| `models/card.py` | 卡牌数据模型 |
| `models/pool.py` | 卡池数据模型 |

### Protobuf 相关（可选）

| 脚本文件 | 说明 |
|---------|------|
| `proto/gacha.proto` | Protobuf 协议定义 |
| `proto/compile_proto.py` | 编译 .proto 文件生成 Python 代码 |
| `proto/converter.py` | Protobuf 与 Python 对象转换器 |
| `proto/grpc_server.py` | gRPC 服务端实现 |

### 服务端模式限制

- **单次最大抽卡数**: 100,000 次（支持压测）
- **历史记录存储**: 最多 1,000 条
- **API 返回结果**: 最多 100 条（减少传输量）

---

## 三、启动方式

### 开发环境

```bash
python main.py
```

### 生产环境

```bash
# Windows (推荐 Waitress)
python run_production.py

# Linux/Mac (推荐 Gunicorn)
python run_production.py --gunicorn
```

### 编译 Protobuf（如需使用 Protobuf 接口）

```bash
python proto/compile_proto.py
```

---

## 四、API 接口对照

### JSON API (`/api/*`)

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/api/pools` | GET | 获取所有卡池 |
| `/api/pools/<pool_id>` | POST | 设置当前卡池 |
| `/api/pull/single` | POST | 单抽 |
| `/api/pull/multi` | POST | 多连抽 |
| `/api/stats` | GET | 获取统计数据 |
| `/api/history` | GET | 获取抽卡历史 |
| `/api/export` | GET | 导出数据 |
| `/api/reset` | POST | 重置数据 |

### Protobuf API (`/proto/*`)

| 接口 | 方法 | 说明 |
|-----|------|------|
| `/proto/pools` | POST | 获取所有卡池 |
| `/proto/pools/set` | POST | 设置当前卡池 |
| `/proto/pull/single` | POST | 单抽 |
| `/proto/pull/multi` | POST | 多连抽 |
| `/proto/stats` | POST | 获取统计数据 |
| `/proto/history` | POST | 获取抽卡历史 |
| `/proto/reset` | POST | 重置数据 |

---

## 五、配置参数说明

### 抽卡限制 (`config.py`)

```python
PULL_LIMITS = {
    'max_single_pull_local': 10000,    # 本地模式单次最大抽卡数
    'max_single_pull_server': 100000,  # 服务端模式单次最大抽卡数
    'max_history_size': 1000,          # 历史记录最大存储数量
    'max_return_results': 100          # API返回结果最大数量
}
```

### 保底机制 (`config.py`)

```python
PITY_CONFIG = {
    'soft_pity': 74,       # 软保底开始抽数
    'hard_pity': 90,       # 硬保底抽数
    'pity_increase': 0.06  # 软保底后每抽增加概率
}
```

### 前端限制 (`static/js/modules/config.js`)

```javascript
const PULL_LIMITS = {
    LOCAL: 10000,    // 本地模式最多1万次
    SERVER: 100000   // 服务端模式最多10万次
};
```

---

## 六、示例代码

### Protobuf 客户端示例

参见 `examples/proto_client_example.py`

```python
from proto import gacha_pb2
import requests

# 多连抽示例
req = gacha_pb2.PullMultiRequest()
req.count = 100

response = requests.post(
    "http://localhost:5007/proto/pull/multi",
    data=req.SerializeToString(),
    headers={'Content-Type': 'application/x-protobuf'}
)

resp = gacha_pb2.PullMultiResponse()
resp.ParseFromString(response.content)
print(f"抽卡结果数: {len(resp.results)}")
```
