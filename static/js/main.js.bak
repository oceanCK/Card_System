/**
 * æŠ½å¡æ¦‚ç‡å·¥å…· - å‰ç«¯äº¤äº’é€»è¾‘
 * æ¨¡å—åŒ–JavaScriptç»“æ„
 * æ”¯æŒæœ¬åœ°æ¨¡å¼å’ŒæœåŠ¡ç«¯æ¨¡å¼åˆ‡æ¢
 */

// ==================== æ¨¡å¼å¸¸é‡ ====================
const MODE = {
    LOCAL: 'local',
    SERVER: 'server'
};

// ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
const AppState = {
    currentPoolId: null,
    isLoading: false,
    lastResults: [],
    mode: localStorage.getItem('gachaMode') || MODE.LOCAL, // é»˜è®¤æœ¬åœ°æ¨¡å¼
    localServiceReady: false,
    serverAvailable: false  // æœåŠ¡ç«¯æ¥å£æ˜¯å¦å¯ç”¨
};

// ==================== DOM å…ƒç´ å¼•ç”¨ ====================
const DOM = {
    // å¡æ± ç›¸å…³
    poolTabs: document.getElementById('poolTabs'),
    poolDesc: document.getElementById('poolDesc'),
    
    // æŠ½å¡æŒ‰é’®
    pullSingle: document.getElementById('pullSingle'),
    pullTen: document.getElementById('pullTen'),
    pullCustom: document.getElementById('pullCustom'),
    customCount: document.getElementById('customCount'),
    resetBtn: document.getElementById('resetBtn'),
    
    // ç»Ÿè®¡æ˜¾ç¤º
    totalPulls: document.getElementById('totalPulls'),
    ssrCount: document.getElementById('ssrCount'),
    srCount: document.getElementById('srCount'),
    rCount: document.getElementById('rCount'),
    ssrRate: document.getElementById('ssrRate'),
    srRate: document.getElementById('srRate'),
    rRate: document.getElementById('rRate'),
    
    // ç»“æœå±•ç¤º
    cardsGrid: document.getElementById('cardsGrid'),
    featuredList: document.getElementById('featuredList'),
    detailsList: document.getElementById('detailsList'),
    
    // å¼¹çª—ç›¸å…³
    exportDataBtn: document.getElementById('exportDataBtn'),
    exportModal: document.getElementById('exportModal'),
    closeModal: document.getElementById('closeModal'),
    exportText: document.getElementById('exportText'),
    copyDataBtn: document.getElementById('copyDataBtn'),
    
    // æ¨¡å¼åˆ‡æ¢ç›¸å…³
    modeToggle: document.getElementById('modeToggle'),
    modeLocalBtn: document.getElementById('modeLocalBtn'),
    modeServerBtn: document.getElementById('modeServerBtn'),
    refreshDataBtn: document.getElementById('refreshDataBtn'),
    modeIndicator: document.getElementById('modeIndicator')
};

// ==================== API è¯·æ±‚æ¨¡å— ====================
const API = {
    /**
     * å‘é€GETè¯·æ±‚
     */
    async get(url) {
        try {
            const response = await fetch(url, {
                credentials: 'same-origin'  // ç¡®ä¿å‘é€cookieä»¥ä¿æŒä¼šè¯
            });
            return await response.json();
        } catch (error) {
            console.error('API GET Error:', error);
            throw error;
        }
    },
    
    /**
     * å‘é€POSTè¯·æ±‚
     */
    async post(url, data = {}) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',  // ç¡®ä¿å‘é€cookieä»¥ä¿æŒä¼šè¯
                body: JSON.stringify(data)
            });
            return await response.json();
        } catch (error) {
            console.error('API POST Error:', error);
            throw error;
        }
    },
    
    // APIç«¯ç‚¹æ–¹æ³•
    setPool: (poolId, autoReset = true) => API.post(`/api/pools/${poolId}`, { auto_reset: autoReset }),
    pullSingle: () => API.post('/api/pull/single'),
    pullMulti: (count) => API.post('/api/pull/multi', { count }),
    getStats: () => API.get('/api/stats'),
    getHistory: (limit = 50) => API.get(`/api/history?limit=${limit}`),
    getExportData: () => API.get('/api/export'),
    reset: () => API.post('/api/reset')
};

// ==================== ç»Ÿä¸€æŠ½å¡å¼•æ“æ¥å£ ====================
const GachaEngine = {
    /**
     * åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºæœ¬åœ°æ¨¡å¼
     */
    isLocalMode() {
        return AppState.mode === MODE.LOCAL;
    },

    /**
     * æ£€æµ‹æœåŠ¡ç«¯æ¥å£æ˜¯å¦å¯ç”¨
     * è¿”å›: { available: boolean, message: string }
     */
    async checkServerAvailable() {
        try {
            // è°ƒç”¨æœåŠ¡ç«¯çŠ¶æ€æ£€æµ‹æ¥å£
            const response = await fetch('/api/server-status', {
                method: 'GET',
                credentials: 'same-origin',
                signal: AbortSignal.timeout(3000)
            });
            
            if (!response.ok) {
                return { available: false, message: `æœåŠ¡ç«¯å“åº”å¼‚å¸¸ (${response.status})` };
            }
            
            const data = await response.json();
            
            // æ£€æŸ¥Unity Protobufæ¥å£æ˜¯å¦å¯ç”¨
            if (data.success && data.available) {
                AppState.serverAvailable = true;
                return { available: true, message: 'æœåŠ¡ç«¯è¿æ¥æ­£å¸¸' };
            } else {
                AppState.serverAvailable = false;
                return { 
                    available: false, 
                    message: data.message || 'æœåŠ¡ç«¯æ¥å£ä¸å¯ç”¨' 
                };
            }
        } catch (error) {
            console.warn('[Server] æœåŠ¡ç«¯æ£€æµ‹å¤±è´¥:', error.message);
            AppState.serverAvailable = false;
            
            if (error.name === 'TimeoutError' || error.name === 'AbortError') {
                return { available: false, message: 'æœåŠ¡ç«¯è¿æ¥è¶…æ—¶' };
            }
            return { available: false, message: 'æœåŠ¡ç«¯æ¥å£ä¸å¯ç”¨' };
        }
    },

    /**
     * æœåŠ¡ç«¯ä¸å¯ç”¨æ—¶çš„ç»Ÿä¸€è¿”å›
     */
    _serverUnavailableResponse(action = 'æ“ä½œ') {
        return {
            success: false,
            message: `æœåŠ¡ç«¯æ¥å£ä¸å¯ç”¨ï¼Œæ— æ³•${action}ã€‚\nè¯·åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼`
        };
    },

    /**
     * è®¾ç½®å¡æ± 
     */
    async setPool(poolId, autoReset = true) {
        if (this.isLocalMode()) {
            return localGachaService.setCurrentPool(poolId, autoReset);
        } else {
            if (!AppState.serverAvailable) {
                return this._serverUnavailableResponse('è®¾ç½®å¡æ± ');
            }
            return await API.setPool(poolId, autoReset);
        }
    },

    /**
     * å•æŠ½
     */
    async pullSingle() {
        if (this.isLocalMode()) {
            return localGachaService.pullSingle();
        } else {
            if (!AppState.serverAvailable) {
                return this._serverUnavailableResponse('æŠ½å¡');
            }
            return await API.pullSingle();
        }
    },

    /**
     * å¤šæŠ½
     */
    async pullMulti(count) {
        if (this.isLocalMode()) {
            return localGachaService.pullMulti(count);
        } else {
            if (!AppState.serverAvailable) {
                return this._serverUnavailableResponse('æŠ½å¡');
            }
            return await API.pullMulti(count);
        }
    },

    /**
     * è·å–ç»Ÿè®¡æ•°æ®
     */
    async getStats() {
        if (this.isLocalMode()) {
            return localGachaService.getStatistics();
        } else {
            if (!AppState.serverAvailable) {
                return this._serverUnavailableResponse('è·å–ç»Ÿè®¡');
            }
            return await API.getStats();
        }
    },

    /**
     * è·å–å†å²è®°å½•
     */
    async getHistory(limit = 50) {
        if (this.isLocalMode()) {
            return localGachaService.getHistory(limit);
        } else {
            if (!AppState.serverAvailable) {
                return this._serverUnavailableResponse('è·å–å†å²');
            }
            return await API.getHistory(limit);
        }
    },

    /**
     * è·å–å¯¼å‡ºæ•°æ®
     */
    async getExportData() {
        if (this.isLocalMode()) {
            return localGachaService.getExportData();
        } else {
            if (!AppState.serverAvailable) {
                return this._serverUnavailableResponse('å¯¼å‡ºæ•°æ®');
            }
            return await API.getExportData();
        }
    },

    /**
     * é‡ç½®
     */
    async reset() {
        if (this.isLocalMode()) {
            return localGachaService.reset();
        } else {
            if (!AppState.serverAvailable) {
                return this._serverUnavailableResponse('é‡ç½®');
            }
            return await API.reset();
        }
    },

    /**
     * åˆ·æ–°æ•°æ®ï¼ˆä»…æœ¬åœ°æ¨¡å¼ï¼‰
     */
    async refreshData() {
        if (this.isLocalMode()) {
            return await localGachaService.refreshData();
        }
        return { success: false, message: 'æœåŠ¡ç«¯æ¨¡å¼æ— éœ€æ‰‹åŠ¨åˆ·æ–°' };
    },

    /**
     * è·å–æ‰€æœ‰å¡æ± ï¼ˆç”¨äºæœ¬åœ°æ¨¡å¼åˆå§‹åŒ–ï¼‰
     */
    getAllPools() {
        if (this.isLocalMode()) {
            return localGachaService.getAllPools();
        }
        return [];
    },

    /**
     * è·å–å½“å‰å¡æ± 
     */
    getCurrentPool() {
        if (this.isLocalMode()) {
            return localGachaService.getCurrentPool();
        }
        return null;
    }
};

// ==================== UI æ›´æ–°æ¨¡å— ====================
const UI = {
    /**
     * æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
     */
    updateStats(stats) {
        DOM.totalPulls.textContent = stats.total_pulls;
        DOM.ssrCount.textContent = stats.ssr_count;
        DOM.srCount.textContent = stats.sr_count;
        DOM.rCount.textContent = stats.r_count;
        DOM.ssrRate.textContent = stats.ssr_rate;
        DOM.srRate.textContent = stats.sr_rate;
        DOM.rRate.textContent = stats.r_rate;
        
        // æ›´æ–°ç‰¹å®šSSRç»Ÿè®¡
        this.updateFeaturedSSR(stats.featured_ssr_counts);
    },
    
    /**
     * æ›´æ–°ç‰¹å®šSSRè·å–ç»Ÿè®¡
     */
    updateFeaturedSSR(counts) {
        if (!counts || Object.keys(counts).length === 0) {
            DOM.featuredList.innerHTML = '<p class="empty-hint">æš‚æ— æ•°æ®</p>';
            return;
        }
        
        let html = '';
        for (const [id, count] of Object.entries(counts)) {
            html += `
                <div class="featured-item">
                    <span class="featured-name">${id}</span>
                    <span class="featured-count">${count} å¼ </span>
                </div>
            `;
        }
        DOM.featuredList.innerHTML = html;
    },
    
    /**
     * æ˜¾ç¤ºæŠ½å¡ç»“æœå¡ç‰‡
     */
    showCards(results) {
        // æœ€å¤šæ˜¾ç¤º10å¼ 
        const displayResults = results.slice(-10);
        
        // æ ¹æ®å¡ç‰‡æ•°é‡è°ƒæ•´æ ·å¼
        if (displayResults.length === 1) {
            DOM.cardsGrid.classList.add('single-card');
        } else {
            DOM.cardsGrid.classList.remove('single-card');
        }
        
        let html = '';
        displayResults.forEach(result => {
            const card = result.card;
            const rarityClass = card.rarity.toLowerCase();
            const imageUrl = card.image_url || `/static/images/cards/${card.card_id}.png`;
            html += `
                <div class="card-item ${rarityClass}">
                    <img class="card-image" src="${imageUrl}" alt="${card.name}" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="card-placeholder" style="display:none;">
                        <span class="card-rarity">${card.rarity}</span>
                        <span class="card-name">${card.name}</span>
                    </div>
                    <div class="card-info">
                        <span class="card-rarity">${card.rarity}</span>
                        <span class="card-name">${card.name}</span>
                    </div>
                </div>
            `;
        });
        
        DOM.cardsGrid.innerHTML = html || '<p class="empty-hint">ç‚¹å‡»æŠ½å¡æŒ‰é’®å¼€å§‹</p>';
    },
    
    /**
     * æ›´æ–°æŠ½å¡è¯¦æƒ…åˆ—è¡¨
     */
    updateDetails(results) {
        if (!results || results.length === 0) {
            DOM.detailsList.innerHTML = '<p class="empty-hint">æš‚æ— æŠ½å¡è®°å½•</p>';
            return;
        }
        
        // æ˜¾ç¤ºæœ€è¿‘çš„è®°å½•ï¼Œæ–°çš„åœ¨ä¸Šé¢
        const displayResults = [...results].reverse().slice(0, 50);
        
        let html = '';
        displayResults.forEach(result => {
            const card = result.card;
            const rarityClass = card.rarity.toLowerCase();
            html += `
                <div class="detail-item">
                    <span class="detail-rarity ${rarityClass}">${card.rarity}</span>
                    <span class="detail-id">${card.card_id}</span>
                    <span class="detail-name">${card.name}</span>
                </div>
            `;
        });
        
        DOM.detailsList.innerHTML = html;
    },
    
    /**
     * è®¾ç½®åŠ è½½çŠ¶æ€
     */
    setLoading(loading) {
        AppState.isLoading = loading;
        const buttons = [DOM.pullSingle, DOM.pullTen, DOM.pullCustom];
        buttons.forEach(btn => {
            btn.disabled = loading;
            if (loading) {
                btn.style.opacity = '0.6';
            } else {
                btn.style.opacity = '1';
            }
        });
    },
    
    /**
     * æ˜¾ç¤ºå¼¹çª—
     */
    showModal(text) {
        DOM.exportText.value = text;
        DOM.exportModal.classList.add('show');
    },
    
    /**
     * éšè—å¼¹çª—
     */
    hideModal() {
        DOM.exportModal.classList.remove('show');
    },
    
    /**
     * é‡ç½®UIæ˜¾ç¤º
     */
    resetUI() {
        DOM.totalPulls.textContent = '0';
        DOM.ssrCount.textContent = '0';
        DOM.srCount.textContent = '0';
        DOM.rCount.textContent = '0';
        DOM.ssrRate.textContent = '0.00%';
        DOM.srRate.textContent = '0.00%';
        DOM.rRate.textContent = '0.00%';
        DOM.cardsGrid.classList.remove('single-card');
        DOM.cardsGrid.innerHTML = '<p class="empty-hint">ç‚¹å‡»æŠ½å¡æŒ‰é’®å¼€å§‹</p>';
        DOM.featuredList.innerHTML = '<p class="empty-hint">æš‚æ— æ•°æ®</p>';
        DOM.detailsList.innerHTML = '<p class="empty-hint">æš‚æ— æŠ½å¡è®°å½•</p>';
        AppState.lastResults = [];
        
        // æœ¬åœ°æ¨¡å¼æ—¶ç¡®ä¿æŠ½å¡æŒ‰é’®å¯ç”¨
        if (AppState.mode === MODE.LOCAL) {
            this.enablePullButtons();
        }
    },

    /**
     * å¯ç”¨æŠ½å¡æŒ‰é’®
     */
    enablePullButtons() {
        DOM.pullSingle.disabled = false;
        DOM.pullTen.disabled = false;
        DOM.pullCustom.disabled = false;
        DOM.pullSingle.style.opacity = '1';
        DOM.pullTen.style.opacity = '1';
        DOM.pullCustom.style.opacity = '1';
    },

    /**
     * ç¦ç”¨æŠ½å¡æŒ‰é’®
     */
    disablePullButtons() {
        DOM.pullSingle.disabled = true;
        DOM.pullTen.disabled = true;
        DOM.pullCustom.disabled = true;
        DOM.pullSingle.style.opacity = '0.5';
        DOM.pullTen.style.opacity = '0.5';
        DOM.pullCustom.style.opacity = '0.5';
    },

    /**
     * æ›´æ–°æ¨¡å¼UI
     */
    updateModeUI() {
        const isLocal = AppState.mode === MODE.LOCAL;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (DOM.modeLocalBtn) {
            DOM.modeLocalBtn.classList.toggle('active', isLocal);
        }
        if (DOM.modeServerBtn) {
            DOM.modeServerBtn.classList.toggle('active', !isLocal);
        }
        
        // æ›´æ–°æŒ‡ç¤ºå™¨
        if (DOM.modeIndicator) {
            if (isLocal) {
                DOM.modeIndicator.textContent = 'ğŸ”Œ æœ¬åœ°æ¨¡å¼';
                DOM.modeIndicator.className = 'mode-indicator local';
            } else {
                DOM.modeIndicator.textContent = AppState.serverAvailable ? 'ğŸŒ æœåŠ¡ç«¯æ¨¡å¼' : 'âš ï¸ æœåŠ¡ç«¯ä¸å¯ç”¨';
                DOM.modeIndicator.className = `mode-indicator ${AppState.serverAvailable ? 'server' : 'unavailable'}`;
            }
        }
        
        // æ˜¾ç¤º/éšè—åˆ·æ–°æŒ‰é’®
        if (DOM.refreshDataBtn) {
            DOM.refreshDataBtn.style.display = isLocal ? 'inline-flex' : 'none';
        }
    },

    /**
     * æ˜¾ç¤ºæœåŠ¡ç«¯ä¸å¯ç”¨æç¤º
     */
    showServerUnavailable(message) {
        // æ¸…ç©ºå¡æ± æ ‡ç­¾ï¼Œæ˜¾ç¤ºæ— æ•°æ®
        DOM.poolTabs.innerHTML = '<span class="no-data-hint">æš‚æ— å¡æ± æ•°æ®</span>';
        DOM.poolDesc.textContent = message || 'æœåŠ¡ç«¯æ¥å£ä¸å¯ç”¨';
        
        // æ›´æ–°å¡ç‰‡æ˜¾ç¤ºåŒºåŸŸ
        DOM.cardsGrid.innerHTML = `
            <div class="server-unavailable">
                <div class="unavailable-icon">ğŸ”Œ</div>
                <div class="unavailable-title">æœåŠ¡ç«¯æ¥å£ä¸å¯ç”¨</div>
                <div class="unavailable-message">${message || 'æœåŠ¡ç«¯æ¥å£ä¸å¯ç”¨'}</div>
                <div class="unavailable-hint">è¯·åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼ä½¿ç”¨</div>
            </div>
        `;
        
        // ç¦ç”¨æŠ½å¡æŒ‰é’®
        this.disablePullButtons();
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        DOM.featuredList.innerHTML = '<p class="empty-hint">æœåŠ¡ç«¯ä¸å¯ç”¨</p>';
        DOM.detailsList.innerHTML = '<p class="empty-hint">æœåŠ¡ç«¯ä¸å¯ç”¨</p>';
        
        // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
        if (DOM.modeIndicator) {
            DOM.modeIndicator.textContent = 'âš ï¸ æœåŠ¡ç«¯ä¸å¯ç”¨';
            DOM.modeIndicator.className = 'mode-indicator unavailable';
        }
    }
};

// ==================== äº‹ä»¶å¤„ç†æ¨¡å— ====================
const EventHandlers = {
    /**
     * å¡æ± åˆ‡æ¢
     */
    async handlePoolChange(e) {
        const tab = e.target.closest('.pool-tab');
        if (!tab) return;
        
        const poolId = tab.dataset.poolId;
        if (poolId === AppState.currentPoolId) return;
        
        try {
            const result = await GachaEngine.setPool(poolId);
            if (result.success) {
                AppState.currentPoolId = poolId;
                
                // æ›´æ–°UI
                document.querySelectorAll('.pool-tab').forEach(t => {
                    t.classList.remove('active');
                });
                tab.classList.add('active');
                
                DOM.poolDesc.textContent = result.pool.description;
                
                // åˆ‡æ¢å¡æ± æ—¶é‡ç½®å‰ç«¯æ˜¾ç¤º
                UI.resetUI();
                
                // è·å–æ–°å¡æ± çš„ç»Ÿè®¡æ•°æ®
                const statsResult = await GachaEngine.getStats();
                if (statsResult.success) {
                    UI.updateStats(statsResult.stats);
                }
            }
        } catch (error) {
            console.error('åˆ‡æ¢å¡æ± å¤±è´¥:', error);
        }
    },
    
    /**
     * å•æŠ½
     */
    async handlePullSingle() {
        if (AppState.isLoading) return;
        
        UI.setLoading(true);
        try {
            const result = await GachaEngine.pullSingle();
            if (result.success) {
                // æ˜¾ç¤ºæœ¬æ¬¡æŠ½å¡ç»“æœ
                UI.showCards([result.result]);
                
                // æœ¬åœ°æ¨¡å¼éœ€è¦å•ç‹¬è·å–ç»Ÿè®¡
                const statsResult = await GachaEngine.getStats();
                if (statsResult.success) {
                    UI.updateStats(statsResult.stats);
                }
                
                // è·å–å®Œæ•´å†å²è®°å½•
                const historyResult = await GachaEngine.getHistory(50);
                if (historyResult.success) {
                    UI.updateDetails(historyResult.history);
                }
            } else {
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                alert(result.message || 'æŠ½å¡å¤±è´¥');
            }
        } catch (error) {
            console.error('æŠ½å¡å¤±è´¥:', error);
            alert('æŠ½å¡è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        } finally {
            UI.setLoading(false);
        }
    },
    
    /**
     * åè¿æŠ½
     */
    async handlePullTen() {
        if (AppState.isLoading) return;
        
        UI.setLoading(true);
        try {
            const result = await GachaEngine.pullMulti(10);
            if (result.success) {
                // æ˜¾ç¤ºæœ¬æ¬¡æŠ½å¡ç»“æœ
                UI.showCards(result.results);
                
                // è·å–ç»Ÿè®¡
                const statsResult = await GachaEngine.getStats();
                if (statsResult.success) {
                    UI.updateStats(statsResult.stats);
                }
                
                // è·å–å®Œæ•´å†å²è®°å½•
                const historyResult = await GachaEngine.getHistory(50);
                if (historyResult.success) {
                    UI.updateDetails(historyResult.history);
                }
            } else {
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                alert(result.message || 'æŠ½å¡å¤±è´¥');
            }
        } catch (error) {
            console.error('æŠ½å¡å¤±è´¥:', error);
            alert('æŠ½å¡è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        } finally {
            UI.setLoading(false);
        }
    },
    
    /**
     * è‡ªå®šä¹‰æŠ½å¡
     */
    async handlePullCustom() {
        if (AppState.isLoading) return;
        
        const count = parseInt(DOM.customCount.value) || 10;
        if (count < 1 || count > 100000) {
            alert('è¯·è¾“å…¥1-100000ä¹‹é—´çš„æ•°å­—');
            return;
        }
        
        UI.setLoading(true);
        try {
            const result = await GachaEngine.pullMulti(count);
            if (result.success) {
                // æ˜¾ç¤ºæœ¬æ¬¡æŠ½å¡ç»“æœ
                UI.showCards(result.results);
                
                // è·å–ç»Ÿè®¡
                const statsResult = await GachaEngine.getStats();
                if (statsResult.success) {
                    UI.updateStats(statsResult.stats);
                }
                
                // è·å–å®Œæ•´å†å²è®°å½•
                const historyResult = await GachaEngine.getHistory(50);
                if (historyResult.success) {
                    UI.updateDetails(historyResult.history);
                }
            } else {
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                alert(result.message || 'æŠ½å¡å¤±è´¥');
            }
        } catch (error) {
            console.error('æŠ½å¡å¤±è´¥:', error);
            alert('æŠ½å¡è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        } finally {
            UI.setLoading(false);
        }
    },
    
    /**
     * é‡ç½®
     */
    async handleReset() {
        if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æŠ½å¡æ•°æ®å—ï¼Ÿ')) return;
        
        try {
            const result = await GachaEngine.reset();
            if (result.success) {
                UI.resetUI();
            }
        } catch (error) {
            console.error('é‡ç½®å¤±è´¥:', error);
        }
    },
    
    /**
     * å¯¼å‡ºæ•°æ®
     */
    async handleExport() {
        try {
            const result = await GachaEngine.getExportData();
            if (result.success) {
                UI.showModal(result.data);
            }
        } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
        }
    },
    
    /**
     * å¤åˆ¶æ•°æ®
     */
    handleCopyData() {
        DOM.exportText.select();
        document.execCommand('copy');
        
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        const originalText = DOM.copyDataBtn.textContent;
        DOM.copyDataBtn.textContent = 'å·²å¤åˆ¶!';
        setTimeout(() => {
            DOM.copyDataBtn.textContent = originalText;
        }, 1500);
    },

    /**
     * æ¨¡å¼åˆ‡æ¢
     */
    async handleModeSwitch(mode) {
        if (mode === AppState.mode) return;
        
        // åˆ‡æ¢åˆ°æœåŠ¡ç«¯æ¨¡å¼æ—¶å…ˆæ£€æµ‹å¯ç”¨æ€§
        if (mode === MODE.SERVER) {
            UI.setLoading(true);
            const checkResult = await GachaEngine.checkServerAvailable();
            UI.setLoading(false);
            
            if (!checkResult.available) {
                // æœåŠ¡ç«¯ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºæç¤ºä½†ä»å…è®¸åˆ‡æ¢ï¼ˆæ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€ï¼‰
                if (!confirm(`${checkResult.message}\n\næœåŠ¡ç«¯æ¥å£å°šæœªå¯¹æ¥ï¼Œåˆ‡æ¢åå°†æ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€ã€‚\næ˜¯å¦ä»è¦åˆ‡æ¢ï¼Ÿ`)) {
                    return;
                }
            }
        }
        
        // åˆ‡æ¢æ¨¡å¼
        AppState.mode = mode;
        localStorage.setItem('gachaMode', mode);
        
        // æ›´æ–°UI
        UI.updateModeUI();
        
        // é‡ç½®æ˜¾ç¤º
        UI.resetUI();
        
        // é‡æ–°åˆå§‹åŒ–
        await initGachaEngine();
    },

    /**
     * åˆ·æ–°æ•°æ®ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰
     */
    async handleRefreshData() {
        if (!GachaEngine.isLocalMode()) {
            alert('æœåŠ¡ç«¯æ¨¡å¼æ— éœ€æ‰‹åŠ¨åˆ·æ–°æ•°æ®');
            return;
        }

        try {
            const result = await GachaEngine.refreshData();
            if (result.success) {
                // åˆ·æ–°å¡æ± æ˜¾ç¤º
                await refreshPoolTabs();
                alert('æ•°æ®åˆ·æ–°æˆåŠŸï¼å¡æ± ä¿¡æ¯å·²æ›´æ–°ã€‚');
            } else {
                alert('æ•°æ®åˆ·æ–°å¤±è´¥ï¼š' + result.message);
            }
        } catch (error) {
            console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
            alert('åˆ·æ–°æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
        }
    }
};

// ==================== æŠ½å¡å¼•æ“åˆå§‹åŒ– ====================
async function initGachaEngine() {
    if (GachaEngine.isLocalMode()) {
        // æœ¬åœ°æ¨¡å¼ï¼šåŠ è½½å¡æ± æ•°æ®
        console.log('[Init] æ­£åœ¨åˆå§‹åŒ–æœ¬åœ°æ¨¡å¼...');
        const loaded = await localGachaService.loadPoolsData();
        if (!loaded) {
            console.error('[Init] æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥ï¼Œå°è¯•åˆ‡æ¢åˆ°æœåŠ¡ç«¯æ¨¡å¼');
            alert('æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ data/cards.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
            return false;
        }
        AppState.localServiceReady = true;
        
        // åˆ·æ–°å¡æ± æ ‡ç­¾
        await refreshPoolTabs();
        
        // ç¡®ä¿æœ¬åœ°æ¨¡å¼ä¸‹æŠ½å¡æŒ‰é’®å¯ç”¨
        UI.enablePullButtons();
    } else {
        // æœåŠ¡ç«¯æ¨¡å¼ï¼šæ£€æµ‹æ¥å£å¯ç”¨æ€§
        console.log('[Init] æ­£åœ¨åˆå§‹åŒ–æœåŠ¡ç«¯æ¨¡å¼...');
        const checkResult = await GachaEngine.checkServerAvailable();
        
        if (!checkResult.available) {
            console.warn('[Init] æœåŠ¡ç«¯æ¥å£ä¸å¯ç”¨:', checkResult.message);
            // æ˜¾ç¤ºæœåŠ¡ç«¯ä¸å¯ç”¨çš„æç¤ºç•Œé¢
            UI.showServerUnavailable(checkResult.message);
            return false;
        }
    }
    
    // åˆå§‹åŒ–å¡æ± é€‰æ‹©
    const activeTab = document.querySelector('.pool-tab.active');
    if (activeTab) {
        AppState.currentPoolId = activeTab.dataset.poolId;
        try {
            const result = await GachaEngine.setPool(AppState.currentPoolId, false);
            if (!result.success) {
                console.warn('[Init] è®¾ç½®å¡æ± å¤±è´¥:', result.message);
                return false;
            }
            const statsResult = await GachaEngine.getStats();
            if (statsResult.success) {
                UI.updateStats(statsResult.stats);
            }
            const historyResult = await GachaEngine.getHistory(50);
            if (historyResult.success && historyResult.history.length > 0) {
                UI.updateDetails(historyResult.history);
            }
        } catch (error) {
            console.error('åˆå§‹åŒ–å¡æ± å¤±è´¥:', error);
        }
    } else {
        const firstTab = document.querySelector('.pool-tab');
        if (firstTab) {
            firstTab.classList.add('active');
            AppState.currentPoolId = firstTab.dataset.poolId;
            try {
                const result = await GachaEngine.setPool(AppState.currentPoolId, false);
                if (result.success) {
                    DOM.poolDesc.textContent = result.pool.description;
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¡æ± å¤±è´¥:', error);
            }
        }
    }
    
    return true;
}

// ==================== åˆ·æ–°å¡æ± æ ‡ç­¾ ====================
async function refreshPoolTabs() {
    if (!GachaEngine.isLocalMode()) return;
    
    const pools = GachaEngine.getAllPools();
    if (pools.length === 0) return;
    
    // æ›´æ–°å¡æ± æ ‡ç­¾
    let html = '';
    pools.forEach((pool, index) => {
        const isActive = pool.pool_id === AppState.currentPoolId || 
                        (index === 0 && !AppState.currentPoolId);
        html += `
            <button class="pool-tab ${isActive ? 'active' : ''}" 
                    data-pool-id="${pool.pool_id}">
                ${pool.name}
            </button>
        `;
    });
    DOM.poolTabs.innerHTML = html;
    
    // æ›´æ–°æè¿°
    const currentPool = GachaEngine.getCurrentPool();
    if (currentPool) {
        DOM.poolDesc.textContent = currentPool.description;
    }
}

// ==================== åˆå§‹åŒ– ====================
async function init() {
    // åˆå§‹åŒ–æ¨¡å¼UI
    UI.updateModeUI();
    
    // ç»‘å®šæ¨¡å¼åˆ‡æ¢äº‹ä»¶
    if (DOM.modeLocalBtn) {
        DOM.modeLocalBtn.addEventListener('click', () => EventHandlers.handleModeSwitch(MODE.LOCAL));
    }
    if (DOM.modeServerBtn) {
        DOM.modeServerBtn.addEventListener('click', () => EventHandlers.handleModeSwitch(MODE.SERVER));
    }
    if (DOM.refreshDataBtn) {
        DOM.refreshDataBtn.addEventListener('click', EventHandlers.handleRefreshData);
    }

    // ç»‘å®šå¡æ± åˆ‡æ¢äº‹ä»¶
    DOM.poolTabs.addEventListener('click', EventHandlers.handlePoolChange);
    
    // ç»‘å®šæŠ½å¡æŒ‰é’®äº‹ä»¶
    DOM.pullSingle.addEventListener('click', EventHandlers.handlePullSingle);
    DOM.pullTen.addEventListener('click', EventHandlers.handlePullTen);
    DOM.pullCustom.addEventListener('click', EventHandlers.handlePullCustom);
    
    // ç»‘å®šé‡ç½®æŒ‰é’®äº‹ä»¶
    DOM.resetBtn.addEventListener('click', EventHandlers.handleReset);
    
    // ç»‘å®šå¯¼å‡ºç›¸å…³äº‹ä»¶
    DOM.exportDataBtn.addEventListener('click', EventHandlers.handleExport);
    DOM.closeModal.addEventListener('click', UI.hideModal);
    DOM.copyDataBtn.addEventListener('click', EventHandlers.handleCopyData);
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    DOM.exportModal.addEventListener('click', (e) => {
        if (e.target === DOM.exportModal) {
            UI.hideModal();
        }
    });
    
    // å›è½¦é”®è§¦å‘è‡ªå®šä¹‰æŠ½å¡
    DOM.customCount.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            EventHandlers.handlePullCustom();
        }
    });
    
    // åˆå§‹åŒ–æŠ½å¡å¼•æ“
    await initGachaEngine();
    
    console.log(`æŠ½å¡æ¦‚ç‡å·¥å…·å·²åˆå§‹åŒ– [${AppState.mode === MODE.LOCAL ? 'æœ¬åœ°æ¨¡å¼' : 'æœåŠ¡ç«¯æ¨¡å¼'}]`);
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', init);
